








WITH staging AS (
-- Generated by AutomateDV (formerly known as dbtvault)

    

WITH source_data AS (

    SELECT

    flight_id,
    flight_no,
    scheduled_departure,
    scheduled_arrival,
    departure_airport,
    arrival_airport,
    status,
    aircraft_code,
    actual_departure,
    actual_arrival

    FROM "postgres"."dwh_detailed"."flights"
),

derived_columns AS (

    SELECT

    flight_id,
    flight_no,
    scheduled_departure,
    scheduled_arrival,
    departure_airport,
    arrival_airport,
    status,
    aircraft_code,
    actual_departure,
    actual_arrival,
    'POSTGRES_MASTER'::TEXT AS RECORD_SOURCE

    FROM source_data
),

hashed_columns AS (

    SELECT

    flight_id,
    flight_no,
    scheduled_departure,
    scheduled_arrival,
    departure_airport,
    arrival_airport,
    status,
    aircraft_code,
    actual_departure,
    actual_arrival,
    RECORD_SOURCE,

    DECODE(MD5(NULLIF(UPPER(TRIM(CAST(flight_id AS VARCHAR))), '')), 'hex') AS HUB_FLIGHTS_KEY,

    DECODE(MD5(CONCAT(
        COALESCE(NULLIF(UPPER(TRIM(CAST(actual_arrival AS VARCHAR))), ''), '^^'), '||',
        COALESCE(NULLIF(UPPER(TRIM(CAST(actual_departure AS VARCHAR))), ''), '^^'), '||',
        COALESCE(NULLIF(UPPER(TRIM(CAST(flight_no AS VARCHAR))), ''), '^^'), '||',
        COALESCE(NULLIF(UPPER(TRIM(CAST(scheduled_arrival AS VARCHAR))), ''), '^^'), '||',
        COALESCE(NULLIF(UPPER(TRIM(CAST(scheduled_departure AS VARCHAR))), ''), '^^'), '||',
        COALESCE(NULLIF(UPPER(TRIM(CAST(status AS VARCHAR))), ''), '^^')
    )), 'hex') AS HASHDIFF,

    DECODE(MD5(NULLIF(UPPER(TRIM(CAST(arrival_airport AS VARCHAR))), '')), 'hex') AS ARRIVAL_AIRPORT_KEY,

    DECODE(MD5(NULLIF(UPPER(TRIM(CAST(departure_airport AS VARCHAR))), '')), 'hex') AS DEPARTURE_AIRPORT_KEY,

    DECODE(MD5(NULLIF(UPPER(TRIM(CAST(aircraft_code AS VARCHAR))), '')), 'hex') AS HUB_AIRCRAFTS_KEY,

    DECODE(MD5(NULLIF(CONCAT(
        COALESCE(NULLIF(UPPER(TRIM(CAST(flight_id AS VARCHAR))), ''), '^^'), '||',
        COALESCE(NULLIF(UPPER(TRIM(CAST(aircraft_code AS VARCHAR))), ''), '^^')
    ), '^^||^^')), 'hex') AS LINK_FLIGHTS_AIRCRAFTS_KEY,

    DECODE(MD5(NULLIF(CONCAT(
        COALESCE(NULLIF(UPPER(TRIM(CAST(flight_id AS VARCHAR))), ''), '^^'), '||',
        COALESCE(NULLIF(UPPER(TRIM(CAST(arrival_airport AS VARCHAR))), ''), '^^')
    ), '^^||^^')), 'hex') AS LINK_FLIGHTS_ARRIVAL_AIRPORT_KEY,

    DECODE(MD5(NULLIF(CONCAT(
        COALESCE(NULLIF(UPPER(TRIM(CAST(flight_id AS VARCHAR))), ''), '^^'), '||',
        COALESCE(NULLIF(UPPER(TRIM(CAST(departure_airport AS VARCHAR))), ''), '^^')
    ), '^^||^^')), 'hex') AS LINK_FLIGHTS_DEPARTURE_AIRPORT_KEY

    FROM derived_columns
),

columns_to_select AS (

    SELECT

    flight_id,
    flight_no,
    scheduled_departure,
    scheduled_arrival,
    departure_airport,
    arrival_airport,
    status,
    aircraft_code,
    actual_departure,
    actual_arrival,
    RECORD_SOURCE,
    HUB_FLIGHTS_KEY,
    HASHDIFF,
    ARRIVAL_AIRPORT_KEY,
    DEPARTURE_AIRPORT_KEY,
    HUB_AIRCRAFTS_KEY,
    LINK_FLIGHTS_AIRCRAFTS_KEY,
    LINK_FLIGHTS_ARRIVAL_AIRPORT_KEY,
    LINK_FLIGHTS_DEPARTURE_AIRPORT_KEY

    FROM hashed_columns
)

SELECT * FROM columns_to_select
)

SELECT *, 
       ('1992-01-01')::TIMESTAMP AS LOAD_DTS,
       ('1992-01-01')::TIMESTAMP AS EFFECTIVE_FROM
FROM staging